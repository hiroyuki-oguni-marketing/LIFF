# liffとecCube連携

## 全体のフロー
- ユーザーがLINEのリッチメニューからリンクをクリック
  - リンクによりLIFFアプリが起動します。 
  - LIFF内の初期処理で、LINEのログイン・認証が行われ、ユーザーのプロフィール（LINE ID、表示名、メールアドレス、プロフィール画像など）が取得されます。

- LIFFアプリで取得したLINEユーザー情報をサーバへ送信
  - 取得情報を元に、事前に用意したEC‑CUBE側の専用APIエンドポイント（例：/api/line-auth）へリクエストが発生します。
  - このリクエストには、セキュリティを担保するための署名やアクセストークンなどが添付され、改ざん防止の仕組みを設けます。

- EC‑CUBE側でユーザー情報のマッピング処理
  - 既存ユーザーの場合：
    - リクエストに含まれるLINEのユニーク識別子（例えば line_user_id）でデータベースを検索します。
    - 既存の会員情報が見つかれば、その情報に基づきセッションまたはアクセストークンを発行。
    - ユーザーはEC‑CUBE側にシームレスにログインし、ショッピングなどの保護された機能を利用可能になります。
  - 未登録ユーザーの場合：
    - 検索結果が無い場合、LIFF経由で取得したLINEのユーザー情報を元に、新規会員登録を実施。
    - 登録には必要な追加情報（ショップ側が必要とする項目）があれば、画面上で追加入力を求めるか、LINEの情報とのマッピング処理で補完可能です。
    - 新規に登録された情報を元に、即座にログイン状態へ移行し、ショッピングへ遷移します。

- シームレスなユーザー体験の提供
  - ログインまたはサインアップ完了後、EC‑CUBE側はユーザーの購入履歴、会員専用ダッシュボード、カート機能などにリダイレクトします。
  - UI上では、LINEの表示名やプロフィール画像を活用することで、違和感なく利用者情報を連携・反映できます。
