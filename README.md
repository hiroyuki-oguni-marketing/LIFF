# liffとecCube連携

## 全体のフロー
- ユーザーがLINEのリッチメニューからリンクをクリック
  - リンクによりLIFFアプリが起動します。 
  - LIFF内の初期処理で、LINEのログイン・認証が行われ、ユーザーのプロフィール（LINE ID、表示名、メールアドレス、プロフィール画像など）が取得されます。

- LIFFアプリで取得したLINEユーザー情報をサーバへ送信
  - 取得情報を元に、事前に用意したEC‑CUBE側の専用APIエンドポイント（例：/api/line-auth）へリクエストが発生します。
  - このリクエストには、セキュリティを担保するための署名やアクセストークンなどが添付され、改ざん防止の仕組みを設けます。

- EC‑CUBE側でユーザー情報のマッピング処理
  - 既存ユーザーの場合：
    - リクエストに含まれるLINEのユニーク識別子（例えば line_user_id）でデータベースを検索します。
    - 既存の会員情報が見つかれば、その情報に基づきセッションまたはアクセストークンを発行。
    - ユーザーはEC‑CUBE側にシームレスにログインし、ショッピングなどの保護された機能を利用可能になります。
  - 未登録ユーザーの場合：
    - 検索結果が無い場合、LIFF経由で取得したLINEのユーザー情報を元に、新規会員登録を実施。
    - 登録には必要な追加情報（ショップ側が必要とする項目）があれば、画面上で追加入力を求めるか、LINEの情報とのマッピング処理で補完可能です。
    - 新規に登録された情報を元に、即座にログイン状態へ移行し、ショッピングへ遷移します。

- シームレスなユーザー体験の提供
  - ログインまたはサインアップ完了後、EC‑CUBE側はユーザーの購入履歴、会員専用ダッシュボード、カート機能などにリダイレクトします。
  - UI上では、LINEの表示名やプロフィール画像を活用することで、違和感なく利用者情報を連携・反映できます。

## 覚え書きとメモ
https://docs.google.com/spreadsheets/d/12_1oDzAibiqi0chSzbYMoRAqnnOXTSlvkIs7Vis03s0/edit?gid=0#gid=0


## 現状の実装
- ユーザーがLINEのリッチメニューからリンクをクリックして、LIFF APP 側の画面に遷移後にLINE ID、表示名、メールアドレス、プロフィール画像が取得できる。（取得できるのはこの４つのみ）
- テストサイトの為、開発モードで運用しており、Admin管理者が招待し、ホワイトリストに入れたアカウントのみ、liffアプリとして正しく稼働する。（ホワイトリストする or Admin権限のアカウントを追加する場合は大国にご連絡ください）
  - LINE DEVELOPERSにアカウント作成
  - ログインチャンネルを設定
  - MessageingAPIチャンネルを設定
  - CDN方式でフロント側にログインユーザーデータを表示
    1. init関数で初期化
    1. getProfile関数で取得
    1. HTML側に取得データを表示
  - ※ec-cube側のUIにすぐ切り替わる想定なので現状jsのフレームワークを入れると共存させるのにコストが掛かりそうなのでCDN方式を取っている
  - 参考:LIFF APIリファレンス https://developers.line.biz/ja/reference/liff/

#### MEMO📝
1. LINEデベロッパーサイトでLIFFの設定、
1. LINEオフィシャルアカウントマネージャー側で友達追加用のアカウント作成と、リッチメニューの設定=>LINEデベロッパーサイト側で作成したLIFFアプリのURLをリッチメニュー側のボタンに設定して、LINE上でLIFFアプリを起動している。
